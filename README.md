# DSU多站自动签到 (基于Ne-21脚本重构)

代码主要由 [DeepSeek](https://chat.deepseek.com/) 编写。

## 写在前面的话

本人能力有限，做出的测试并不多，脚本使用过程中可能遇到各种各样的 BUG。

脚本已经在 [GitHub](https://github.com/little3tar/discuz-dsu-checkin) 开源，**请一定要来**修复某个 BUG 或完善添加更多支持的网站，拜托拜托ᓚᘏᗢ

## 背景

在使用 [Ne-21](https://scriptcat.org/zh-CN/users/227) 发布的 [DSU每日自动签到(上云版)](https://scriptcat.org/zh-CN/script-show-page/332) 时，我发现有几个网站使用的是同样的签到方式，于是想到一个脚本能否能签到多个网站。

说干就干，感谢 AI，此脚本基于**DSU每日自动签到(上云版)**，在 AI 的帮助下拓展了脚本的功能，现在支持同样使用 Discuz! + DSU签到插件（dsu_paulsign） 进行签到的网站（可能？）。

## 支持的网站

脚本内置支持以下网站：

1. **油猴中文网** - <https://bbs.tampermonkey.net.cn>
2. **Anime字幕论坛** - <https://bbs.acgrip.com>  
3. **天使动漫论坛** - <https://www.tsdm39.com>

可以通过修改脚本顶部 `const SITES` 配置来添加更多支持 DSU 签到的网站，或者通过设置 `enabled` 参数为 `true/false` 来控制是否启用特定网站的签到功能。

## 安装和使用

### 前置要求

1. 安装 [ScriptCat](https://scriptcat.org/) 浏览器扩展
2. 确保在支持的网站中已经登录账号

### 安装步骤

1. 访问脚本发布页面：<https://scriptcat.org/zh-CN/script-show-page/4495>
2. 点击"安装脚本"按钮

### 使用方法

脚本安装后会自动运行，提供以下功能：

#### 自动签到

- 脚本加载时自动执行批量签到
- 支持定时任务（通过 `@crontab * * once * *` 配置）

#### 手动操作菜单

在浏览器扩展菜单中可以看到以下选项：

- **🚀 立即签到** - 手动强制执行全部签到任务
- **⚡ 重试失败站点** - 重试上次签到失败的网站

## 核心功能特性

### 1. 多站点支持

- 同时支持多个使用 DSU 签到插件的网站
- 可配置启用/禁用特定网站
- 支持自定义添加新网站

### 2. 智能重试机制

- 自动重试失败的签到请求
- 可配置重试次数（默认3次）
- 重试间隔时间可配置（默认2秒）

### 3. 错误处理

- 完善的网络错误处理
- 登录状态检测
- 表单哈希值获取失败处理

### 4. 状态管理

- 记录失败的站点列表
- 支持失败站点的单独重试
- 签到结果持久化存储

### 5. 用户通知

- 签到完成后的桌面通知
- 详细的签到结果反馈
- 区分正常签到和重试操作的通知

### 6. 防重复执行

- 防止脚本重复运行
- 请求间隔控制，避免过于频繁

## 技术实现

### 签到流程

1. 获取签到页面的 `formhash` 值
2. 使用获取到的 `formhash` 提交签到请求
3. 解析返回结果，判断签到是否成功

### 重试策略

- 网络错误时自动重试
- 获取 `formhash` 失败时重试
- 签到请求失败时重试
- 超过最大重试次数后记录为失败

### 数据存储

使用 Tampermonkey 的 `GM_setValue` 和 `GM_getValue` API 存储：

- 站点配置信息
- 失败站点列表
- 签到历史记录

## 配置说明

### 站点配置

在脚本顶部 `const SITES` 数组中添加新网站：

```javascript
{
    name: '网站名称',
    signPageUrl: '签到页面URL',
    signApiUrl: '签到API URL',
    referer: 'Referer头',
    domain: 'Cookie域',
    enabled: true  // 是否启用
}
```

### 重试配置

在 `const RETRY_CONFIG` 中配置：

- `maxRetries`: 最大重试次数
- `retryDelay`: 重试间隔时间（毫秒）
- `timeout`: 请求超时时间（毫秒）

## 注意事项

1. **登录状态**: 脚本依赖浏览器缓存的登录信息，使用前请确保已在支持的网站登录
2. **Cookie权限**: 脚本需要访问相关网站的 Cookie，安装时会请求权限
3. **网络要求**: 需要稳定的网络连接，建议使用代理访问国外网站
4. **Anime字幕论坛**: 该网站风控较严格，可能需要人机验证，建议先手动访问网站

## 已知问题

- 打开浏览器必须运行一次才能看到手动触发菜单
- 某些网站可能需要先手动访问才能正常签到
- 网络不稳定时可能导致签到失败

## 更新日志

### v0.2.0

- 重构代码结构，提高可维护性
- 添加智能重试机制
- 优化错误处理和用户反馈
- 支持失败站点单独重试

## 贡献指南

欢迎提交 Issue 和 Pull Request 来：

- 报告 BUG
- 添加新网站支持
- 改进代码质量
- 优化用户体验

## 免责声明

本脚本仅供学习研究使用，使用脚本请遵守相关网站的服务条款。因使用本脚本造成的任何问题，开发者不承担任何责任。
